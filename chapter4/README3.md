# 第三章 出入库和内部调拨

## 入库单批次号逻辑

入库类型上面有两个选项

* 创建新的批次
* 使用已有批次

这两个选择会在调拨单上显示不同的字段，创建新的批次会显示一个字符串的文本，以供用户输入新的批次号，使用已有批次则会显示一个多对一的字段，让用户即可以创建新的批次，也可以选择既有的批次。

批次显示文本批次号的逻辑是：

* 启用了批次跟踪且调拨单类型启用了创建新批次，且调拨单状态尚未完成

其他时候均使用多对一的批次号

## 库存移动

### 销售策略对出库单的影响

我们在销售单一节中曾经提到过出库策略设置，之前仅仅说明了会对订单交付时间的影响。实际上，订单策略的选择还会对出库单的状态造成影响。下面我们就详细分析其内部的逻辑。

销售单中的两个选择**尽快**和**当全部产品就绪时**对应技术上的两个值：direct和one，这两个值不是随便设置的，这两个值与库存移动(stock.move)中的移动类型(move_type)的选项相对应。

出库单的状态与明细中的库存移动（stock.move)有着十分紧密的联系，具体地来说，当出库单需要确定状态时，会先将明细中的库存移动按照**状态**和**数量**进行排序，具体的状态优先级如下：

* confirmed: 确认
* partially_available：部分就绪
* waiting：等待其他操作
* assigned：就绪

排序以后，根据第一行的库存移动进行判断：

1. 如果第一行移动的移动类型是**当全部产品就绪**，系统会把第一行作为**最重要的移动**，并进行如下的逻辑判断：

    1. 如果最重要的移动状态是确认且数量有效，则整个出库单的状态为确认，如果数量无效，则出库单状态为就绪。
    2. 如果最重要的移动状态是部分就绪，则整个出库单为确认状态，并不会显示部分就绪状态。
    3. 如果最重要的移动状态是等待其他操作或者就绪，整个出库单状态为等待其他操作或者就绪。

2. 如果第一行的库存移动状态非就绪且其他库存移动中有处于就绪或部分就绪的状态时，整个出库单的状态是部分就绪。

3. 如果不属于上述两种情况，则取**最后一行**作为**最不重要的库存移动**，并进行如下判断：
    1. 如果最不重要库存移动状态是确认且库存移动数量为0，则整单状态为就绪。
    2. 否则以最不重要的库存移动状态作为整单状态。

## 库存移动明细