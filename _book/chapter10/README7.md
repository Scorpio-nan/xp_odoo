# 企业微信解决方案

> 本模块当前支持13.0 15.0 16.0

## 需求背景

企业微信作为当前企业内部沟通的几大内部IM软件之一,其优势在于能够跟微信打通,方便与客户联系。很多客户都有需求，要在企业微信内部对工作进行及时通知和反馈，在企业微信中进行审批，乃至统计员工的考勤和费用等等。

本模块将展示，通过与odoo的关联，我们将如何利用企业微信提高我们的工作效率。

## 企业微信管理后台配置

首先，要使用[企业微信](https://work.weixin.qq.com/)，您必须要先注册一个企业微信账号。

注册完成之后，使用管理员账号登录[管理后台](https://work.weixin.qq.com/wework_admin/frame)

### 创建应用

要使用企业微信，我们需要创建一个应用。在企业微信后台-应用管理-创建应用，创建一个应用。这里我们起名Odoo：

![1](./images/wework1.png)

### 获取基础参数

然后，我们需要获取以下三个参数：

* 企业ID: 在企业微信后台-我的企业获取，例： ww123456
* AgentID： 应用ID，例：1000001
* 密钥：应用密钥，例：abcdefghijklmn

然后我们需要设置**网页授权及JS-JDK的域名**用于OAuth授权：

![2](./images/wework2.png)

最后，还要把服务器的IP加入到**企业可信IP**的白名单中。

## Odoo端配置

我们在企业微信后台配置完成之后，就可以在odoo中进行接入了。首先，在用户管理中，把用户加入到**企业微信经理**用户组中。

然后我们在主菜单中点击企业微信，进入企业微信模块内。在企业微信模块-设置-企业微信中，填入我们前面拿到的几个参数：

![3](./images/wework3.png)

> 如果需要验证域名归属，将后台生成的验证文本文件名和内容分别填入到域名设置中即可完成校验。

```python
pip3 install -U /tmp/v2.0.0.alpha27.zip -i https://mirrors.cloud.tencent.com/pypi/simple
```

### 绑定公司

设置完企业微信应用之后，我们还要绑定使用的公司才能正常使用。在企业微信-公司-企业微信选项卡中，选中我们刚才创建的应用。

![4](./images/wework4.png)

这样就完成了Odoo端的基础配置。下面我们来看一下企业微信模块拥有哪些功能。

## 功能介绍

### 基础数据同步

接入企业微信后的第一件事就是把企业微信中的部门和员工数据同步到Odoo中，我们在企业微信-设置-同步部门/同步员工，两个菜单可以分别完成两个同步动作。

![5](./images/wework5.png)

![6](./images/wework6.png)

同步员工数据时，默认根据员工姓名进行匹配，也可以在应用的设置中调整匹配策略。目前支持的匹配策略有：

* 根据姓名匹配
* 根据邮箱匹配
* 根据电话匹配
* 根据邮箱或电话匹配
* 以上任意一条满足匹配

### 扫码登录

同步完基础数据，那么就可以开启扫码登录功能，简化员工登录步骤。在设置-用户-OAuth服务商中，打开Wework OAuth Provider一行:

![7](./images/wework7.png)

勾选允许选项。然后将企业ID和AgentID分别填入企业ID和客户ID即可。

我们退出登录就可以看到登录界面多出了一个企业微信登录按钮，点击出现扫码登录界面，使用企业微信扫码即可完成登录。

![8](./images/wework8.png)

![9](./images/wework9.png)

### 菜单设置

我们的自定义应用会出现在企业微信的应用列表中，应用支持自定义菜单，我们可以在系统中设置我们想要的菜单，并分配合适的动作。

![10](./images/wework10.png)

一个应用可以支持最多3个一级菜单和5个二级菜单。

我们可以在菜单设置中直接关联我们系统中的特定页面，从而一键直达想要的数据。

![11](./images/wework11.png)


### 工作台设置*

与应用主页相比，工作台的位置更为显眼，而且可以定制数据展示方式。

在企业微信-应用-工作台中，创建一个工作台，并设置它的样式：

![12](./images/wework12.png)

然后用户可以在企业微信客户端的工作台出看到我们定制的数据展示:

![13](./images/wework13.png)

### 机器人消息

我们很多业务消息可以借助机器人来实现实时同步，本模块即支持定制化的机器人消息。下面，我们来看一下如何配置一个机器人实现业务消息实时发送。

首先，我们需要创建一个机器人。在机器人菜单下，我们创建一个机器人：

![Robot](./images/wework14.png)

Webhook URL:写我们创建的机器人的URL地址。

发送机器人消息，我们在菜单机器人-机器人消息下，创建一条测试消息：

![Robot Message](./images/wework15.png)

然后我们就可以在机器人所在的群接收到这个消息了。

![Robot Message](./images/wework16.png)

### 讨论组消息

为了跟方便的与企业微信互通, 我们在设置中加入了即时通讯设置, 用户需要在设置中打开这个开关：

![19](./images/wework19.png)

然后在任一单据的邮件讨论区@某员工,会自动发一条企业微信通知。

![25](./images/wework25.png)

某员工会即时在企业微信中收到该消息。

![20](./images/wework21.png)

## 高级应用设置

以下功能为高级功能，为了全方位满足企业管理需求而增加的功能。

### 项目

我们对项目模块也加入了支持，用户需要在设置中打开项目支持功能

![22](./images/wework22.png)

当项目管理员在任务中给员工分配了任务时，会自动给员工发送一条企业微信通知。

![23](./images/wework23.png)

![24](./images/wework24.png)

员工还可以在企业微信里直接通过链接打开该任务。

### 考勤

企业微信方案解决了日常公司管理中的考勤问题，下面我们看一下如何使用。

首先，我们要把在企业微信管理后台把打卡的权限开放给我们的自建应用。

![17](./images/wework17.png)

> 企业微信官方于2023-12-01之前的应用使用打卡专属APPID和密钥，之后的版本取消了。

我们点击设置-考勤-同步考勤：

![18](./images/wework18.png)

即可同步当日考勤记录，同时系统也会把考勤日志同步到原生考勤日志中。

## 结语

利用企业微信，接合odoo我们可以做的事情有很多，例如流程审批和员工考勤等等。本文只是介绍了企业微信解决方案的基础部分和常见的使用场景。更多的功能，我们将在后面的高级应用部分举例。

关于Odoo企业微信更多的应用消息，请关注公众号OdooHub。
