# 第一章 门户

* [门户销售](#门户销售)
* [多公司下的门户链接](#多公司条件下的门户链接)

## 门户销售

### 门户销售订单的搜索

门户销售默认情况下仅支持排序,并不支持搜索和分组查询:

![1](images/1.png)

为了方便门户用户的使用,我们在欧姆网络解决方案的[门户销售解决方案](https://odoohub.com.cn)中,增加了对销售订单的搜索,分组和查询支持。

![2](images/2.png)

筛选新增了如下支持:

![3](images/3.png)

分组新增了如下支持:

![4](images/4.png)

搜索新增了以下选项:

![5](images/5.png)

### 门户订单的产品图片

客户在我们的网站上中注册成为门户用户之后，可以在个人中心中浏览自己的订单，样式如下图：

![preview](./images/preview.png)

原生odoo并没有将产品的图片显示出来。有时候我们希望能够让客户在自己的门户上就能查看产品图片，也可以对图片进行放大和缩小以及下载等操作。为此，我们在[门户解决方案](https://odoohub.com.cn)中加入了对此功能的支持。

我们在设置-销售-报价单和销售订单中，选中在销售订单中显示产品图片的选项。

![image](images/image.png)

保存之后，我们就可以在门户的预览页面看到产品明细中显示了产品图片：

![sale](images/portal_sale.png)

当我点击该图片时，可以预览此图片，进行放大、缩小和下载等操作。

![preview](./images/portal_sale_preview.png)

## 多公司条件下的门户链接

有时候我们会有多家公司，多家公司下又有多个网站，这个时候客户容易在多个网站间混乱。我们在系统中给客户发送邀请或重置密码等邮件时，需要根据客户所在的公司/网站进行不同的URL划分。

原生情况下，Odoo支持对门户用户发送的URL网址进行分类，分类的依据是下面的规则：

1. 客户资料中如果绑定了网站，那么使用该网站的URL作为邮件链接的URL。
![6](./images/6.png)

2. 如果客户资料中没有，则根据客户的公司字段绑定的网站的URL作为邮件链接的URL。

3. 如果上述2个条件都不满足，则使用系统设置中的web.base.url的值作为邮件链接的URL。

但有时候我们希望生成的邀请/重置链接依据当前公司来进行生成，基于这种需求，在我们的[欧姆网络](https://www.odoohub.com.cn)解决方案中做了配置：

在设置-通用设置-权限中，选中基于公司的的门户链接选项即可。

![7](./images/7.png)

这样配置完成以后，生成的链接就基于当前公司的网站域名生成相应的邀请链接了。

为了方便共享文档，odoo在每个文档模型中都加入了共享链接的快捷分享功能，用户可以方便的在想要分享的文档上将文档的链接分享给客户/供应商。我们以销售订单为例，来看一下分享功能的使用方法。

## 共享

我们在想要分享的文档上点击动作-分享，会弹出一个对话框：

![8](./images/8.png)

![9](./images/9.png)

在显示的对话框中有如下字段：

* 链接：分享链接，可以复制发送给客户的共享链接
* 接收人: 邮件的接收人
* 备注： 分享的备注

我们可以选择给客户发送邮件通知，也可以选择复制链接通过社交媒体的方式发送给客户。使用邮件通知的话，客户将受到一封共享邮件，点击邮件中的链接即可跳转到相应的销售单界面。

### 页面跳转逻辑

默认情况下，邮件的跳转链接会根据当前用户的权限选择显示不同的页面。如果当前用户拥有该文档的访问权限，那么页面将导向后台订单系统（要求登陆）。如果用户没有该文档的访问权限（例如，公共用户），那么系统将直接显示前台的订单页面。

![10](./images/10.png)

> 因此我们在设置权限的时候需要注意，如果不希望客户登陆后台系统，就不要给客户拥有该文档的访问权限。

### 令牌

Odoo在实现上述逻辑的过程中使用了中间授权的访问令牌(Access Token)。访问令牌本质上一个uuid，当用户点击分享的时候赋值给了当前的文档。

当用户使用共享的链接进行访问时，如果用户不具备文档的访问权限，那么系统就会校验链接中携带的访问令牌是否有效。有效则进行前端展示，无效则跳转登陆页面。

每个文档只会生成一个令牌且令牌将一直有效，直到该文档的令牌被刷新。

### 多令牌和令牌管理

前面讲到过，因为每个文档只能有一个访问令牌。当我们想要将一个文档分享给不同的客户，且想要控制不同的客户的访问有效期的话，就满足不了我们的需求了。因此，我们在[门户解决方案](https://odoohub.com.cn)中增加了多令牌和令牌有效期管理的功能。

首先，我们要在设置-欧姆-门户中选中门户拓展：

![11](./images/11.png)

如果需要销售订单共享令牌控制，则选中门户销售，点击保存即可。

#### 多令牌控制

安装了门户拓展之后，我们可以到设置-技术-数据模型-门户Token中对多令牌进行管理

![13](./images/13.png)

所有系统中生成的门户令牌都会在这里进行显示。我们可以在这里对令牌进行控制：

* 模型： 文档的模型
* res_id: 文档的关联ID
* 合作伙伴： Token所属的合作伙伴
* Access Token：访问令牌
* 过期日期：令牌的有效期，超过此时间令牌无效。

#### 销售单令牌控制

安装了门户销售拓展之后，我们再去分享销售订单时，分享界面将变成下图所示：

![14](./images/14.png)

我们可以在此界面选择分配给客户的Token有效期，以控制客户可以访问订单的时间范围。点击发送之后，我们可以在销售订单直接管理令牌：

![15](./images/15.png)

如果我们希望分享给第二个人更长的时间，则再次点击分享按钮即可：

![16](./images/16.png)

我们可以在令牌列表中对既有的Token进行管理：

![17](./images/17.png)
